<div class="row">
    <nav class="navbar navbar-default">
        <div class="container">
            <h1 class="text-center text-capitalize">Room {{ id }}</h1>
        </div>
        <!--<a class="text-right" href="/"><span class="glyphicon glyphicon-remove-sign"></span> Leave</a>-->
    </nav>

    <div class="row" id="player-list"></div>
</div>
<script>

    var socket = io();
    var room = '{{ id }}';
    socket.on('connect', function(){
        var socketId = socket.id;
        socket.emit('join', {roomId: room, socketId: socketId});
    });

    var getPlayers = function(data){
        console.log(data);
        var selfObj = data['self'];
        var othersObjs = data['others'];

        var playerList = [];
        playerList.push(selfObj);
        playerList = playerList.concat(othersObjs);

        return playerList;
    };

    var updateView = function(players){
        console.log(players);
        var playerHtml = '';

        for(var i = 0; i <= players.length - 1; i++){
            var readyClass = players[i]['ready'] == 0? 'text-danger':'text-success';
            var readyText = players[i]['ready'] == 0? 'Not Ready':'Ready';
            var readyButton = (i == 0)?'<button class="btn btn-info ready-button" data-id=' + players[i]['id'] + '>Ready</button>': '';
            var selfClass = (i == 0)?'col-xs-6 col-xs-offset-3': 'col-xs-6';
            playerHtml +=
                    '<div class="'+ selfClass +' player_' + players[i]['id'] +'">'
                    + '<div class="panel panel-default">'
                    + '<div class="panel-heading text-center">' + players[i]['nick_name'] +'</div>'
                    + '<div class="panel-body text-center">'
                    + '<div class="' + readyClass +' ready-status">' + readyText + '</div>'
                    + '<img src="/content/img/user_1.png" class="img-circle img-responsive center-block" style="width: 100px;">'
                    + '<div>'
                    + readyButton
                    + '</div>'
                    + '</div>'
                    + '</div>'
                    + '</div>';
        }

        if(playerHtml){
            $("#player-list").empty().html(playerHtml);
        }
    };

    updateView(getPlayers({{{json players}}}));

    socket.on('updatePlayers', function(data){
        updateView(getPlayers(data));
    });

    $('.ready-button').on('click', function(){
        var oldStatus = $('.ready-status').text().toLowerCase() == 'ready'?1:0;
        var newStatus = oldStatus == 0? 1: 0;

        socket.emit('ready', {'player_id': $(this).data('id'), 'room_id': '{{ id }}', ready: newStatus});
    });

    socket.on('player_ready', function(data){
        console.log('player_ready', data);
        var findClass = 'player_' + data;
        var $readyStatus = $("." + findClass).find('.ready-status');
        if($readyStatus.hasClass('text-danger')){
            $readyStatus.removeClass('text-danger');
            $readyStatus.addClass('text-success');
            $readyStatus.text('Ready');
        } else {
            $readyStatus.removeClass('text-success');
            $readyStatus.addClass('text-danger');
            $readyStatus.text('Not Ready');
        }
    });

</script>