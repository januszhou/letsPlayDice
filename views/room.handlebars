<div class="row">
    <nav class="navbar navbar-default">
        <div class="container">
            <h1 class="text-center text-capitalize">Room {{ roomId }}</h1>
        </div>
        <!--<a class="text-right" href="/"><span class="glyphicon glyphicon-remove-sign"></span> Leave</a>-->
    </nav>

    <div class="row" id="player-list"></div>
</div>
<script>
    $(document).ready(function(){
        $.cookie.json = true;
        var socket = io();
        var roomId = '{{ roomId }}';
        var player = {{{json player}}};

        $.cookie('dice', {roomId: roomId, player: player});

        socket.on('connect', function(){
            var socketId = socket.id;
            socket.emit('join', {roomId: roomId, socketId: socketId, playerUID: player.UID});
        });

        var getPlayers = function(data){
            var cookie = $.cookie('dice');
            var currentUserId = cookie.player.UID;
            var currentUserObj = null;
            for(var i = 0; i <= data.length - 1; i++){
                if(data[i].UID == currentUserId){
                    currentUserObj = data[i];
                    delete data[i];
                }
            }

            if(currentUserObj){
                data.unshift(currentUserObj);
            }

            return data;
        };

        var updateView = function(players){
            console.log(players);
            var playerHtml = '';

            for(var i = 0; i <= players.length - 1; i++){
                if(!players[i]){
                    continue;
                }
                var readyClass = players[i]['ready']? 'text-success': 'text-danger';
                var readyText = players[i]['ready']? 'Ready': 'Not Ready';
                var readyButton = (i == 0)?'<button class="btn btn-info ready-button" data-id=' + players[i]['UID'] + '>Ready</button>': '';
                var selfClass = (i == 0)?'col-xs-6 col-xs-offset-3': 'col-xs-6';
                playerHtml +=
                        '<div class="'+ selfClass +' player_' + players[i]['UID'] +'">'
                        + '<div class="panel panel-default">'
                        + '<div class="panel-heading text-center">' + players[i]['nickName'] +'</div>'
                        + '<div class="panel-body text-center">'
                        + '<div class="' + readyClass +' ready-status">' + readyText + '</div>'
                        + '<img src="/content/img/user_1.png" class="img-circle img-responsive center-block" style="width: 100px;">'
                        + '<div>'
                        + readyButton
                        + '</div>'
                        + '</div>'
                        + '</div>'
                        + '</div>';
            }

            if(playerHtml){
                $("#player-list").empty().html(playerHtml);
            }

            $('.ready-button').on('click', function(){
                var UID = $(this).data('id');
                console.log($('.player_' + UID).find('.ready-status').text());
                var oldStatus = $('.player_' + UID).find('.ready-status').text().toLowerCase() == 'ready'?1:0;
                var newStatus = !oldStatus;

                socket.emit('ready', {'player_id': UID, 'room_id': roomId, ready: newStatus});
                console.log('emitted ready', {'player_id': $(this).data('id'), 'room_id': roomId, ready: newStatus});
            });
        };

        socket.on('updatePlayers', function(data){
            console.log(data);
            updateView(getPlayers(data));
        });

        socket.on('hello', function(data){
            console.log(data);
        });
    });
</script>